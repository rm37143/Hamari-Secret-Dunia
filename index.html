<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret World - Stable Design</title>
    <style>
        :root { --pink: #ff85a2; --glass: rgba(255, 255, 255, 0.9); --green: #2ecc71; --grey: #bdc3c7; }
        body { background: #fce4ec; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 15px; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 400px; text-align: center; }
        .main-title { color: var(--pink); margin: 10px 0 20px 0; font-size: 1.8rem; font-weight: bold; }
        .welcome-title { font-size: 2.2rem; font-weight: 800; margin: 5px 0; background: linear-gradient(to right, #ff85a2, #ff4d4d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card { background: var(--glass); backdrop-filter: blur(10px); padding: 25px; border-radius: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); border: 1px solid white; margin-bottom: 15px; }
        input { width: 85%; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 25px; outline: none; text-align: center; }
        .btn-main { background: var(--pink); color: white; border: none; padding: 14px 30px; border-radius: 30px; font-weight: bold; width: 100%; cursor: pointer; }
        #dashboard { display: none; }
        .status-bar { background: #fff; padding: 12px 15px; border-radius: 15px; margin-bottom: 15px; font-size: 0.8rem; border-left: 6px solid var(--green); text-align: left; }
        .user-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; border-bottom: 1px solid #f2f2f2; padding-bottom: 5px; }
        .user-info { display: flex; align-items: center; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot-online { background: var(--green); box-shadow: 0 0 5px var(--green); }
        .dot-offline { background: var(--grey); }
        .bell-icon { cursor: pointer; margin-left: 10px; font-size: 1rem; filter: grayscale(1); transition: 0.3s; }
        .bell-active { filter: grayscale(0); transform: scale(1.2); }
        .off-btn { background:#ff4d4d; color:white; border:none; border-radius:8px; padding:4px 12px; font-size:0.7rem; cursor:pointer; font-weight: bold; }
        textarea { width: 100%; border: none; background: transparent; font-style: italic; resize: none; outline: none; min-height: 60px; font-size: 1rem; }
    </style>
</head>
<body onload="clearInputs()">

<div class="container">
    <h2 class="main-title">Hamari Secret Dunia</h2>

    <div id="login-screen" class="card">
        <h1 class="welcome-title">Welcome</h1>
        <input type="text" id="u-name" placeholder="Enter Name">
        <input type="password" id="u-pass" placeholder="Enter Key">
        <button class="btn-main" onclick="checkAuth()">Unlock World</button>
    </div>

    <div id="dashboard">
        <div class="status-bar" id="status-container">Connecting...</div>

        <div class="card" style="text-align: left; border-left: 5px solid var(--pink);">
            <h4 style="margin:0; font-size:0.8rem; color:var(--pink);">Write New Note:</h4>
            <textarea id="note-input" placeholder="Type Here..."></textarea>
            <button onclick="sendNote()" id="send-btn" style="background:var(--pink); color:white; border:none; border-radius:15px; padding:6px 20px; font-size:0.8rem; cursor:pointer; float:right;">Send</button>
            <div style="clear:both;"></div>
        </div>

        <div class="card" style="text-align: left; background: #f9f9f9; border-left: 5px solid #bbb;">
            <h4 style="margin:0; font-size:0.75rem; color:#777;">Previous Note:</h4>
            <button id="lock-btn" onclick="showLockedNote()" style="width:100%; margin-top:10px; border:1px dashed #ccc; background:none; padding:10px; cursor:pointer; border-radius:15px;">Show Locked Note ðŸ”’</button>
            <div id="prev-note-display" style="display:none;">
                <div id="prev-note-text" style="font-style: italic; color: #555; margin-top:5px; font-size: 0.95rem;">Loading...</div>
                <div id="prev-note-info" style="font-size: 0.65rem; color: #aaa; text-align: right; margin-top: 5px;">--:--</div>
                <button onclick="lockNoteAgain()" style="font-size:0.6rem; color:red; border:none; background:none; cursor:pointer; float:right; margin-top:5px;">[ Close & Lock ]</button>
            </div>
        </div>
        <button onclick="viewFullHistory()" style="background:none; border:1px solid #ccc; color:#888; padding:10px; border-radius:20px; font-size:0.75rem; width:100%; margin-top:10px; cursor:pointer;">View All Notes History ðŸ”’</button>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwe_qtaFURKaKeD6FX-O7yBHFebq7Qwkiznrf9PjUZMzKe5Hi1JYGsNmsQr1zSpC_7c/exec';
    let currentUser = "";
    let myBell = "OFF";
    let lastStatusMap = {};
    const bellSound = new Audio('https://www.soundjay.com/buttons/sounds/button-30.mp3');

    function clearInputs() { document.getElementById('u-name').value = ""; document.getElementById('u-pass').value = ""; }

    function checkAuth() {
        const n = document.getElementById('u-name').value.toLowerCase().trim();
        const p = document.getElementById('u-pass').value.trim();
        if((n === 'awais' && p === '37143') || (n === 'nisha' && p === 'n37143')) {
            currentUser = n.charAt(0).toUpperCase() + n.slice(1);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateStatus("Online");
            refreshData(); 
            setInterval(refreshData, 5000); 
        } else { alert("Unauthorized!"); clearInputs(); }
    }

    function updateStatus(status) {
        fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "updateStatus", name: currentUser, status: status }) });
    }

    function toggleBell() {
        myBell = (myBell === "OFF") ? "ON" : "OFF";
        fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "updateBell", name: currentUser, bell: myBell }) });
        refreshData();
    }

    function refreshData() {
        fetch(scriptURL).then(res => res.json()).then(data => {
            let html = "";
            data.onlineUsers.forEach(user => {
                if(user.name && user.name !== "Name") {
                    const isMe = user.name === currentUser;
                    if(isMe) myBell = user.bell;

                    if(!isMe && user.status === "Online" && lastStatusMap[user.name] !== "Online" && myBell === "ON") {
                        bellSound.play().catch(() => {});
                    }
                    lastStatusMap[user.name] = user.status;

                    html += `<div class="user-row">
                                <div class="user-info">
                                    <span class="dot ${user.status==='Online'?'dot-online':'dot-offline'}"></span>
                                    <b>${user.name}</b>
                                    <span onclick="${isMe ? 'toggleBell()' : ''}" class="bell-icon ${user.bell === 'ON' ? 'bell-active' : ''}">
                                        ${user.bell === 'ON' ? 'ðŸ””' : 'ðŸ”•'}
                                    </span>
                                </div>
                                ${isMe ? `<button class="off-btn" onclick="logout()">OFF</button>` : ''}
                             </div>`;
                }
            });
            document.getElementById('status-container').innerHTML = html;
        });
    }

    function sendNote() {
        const note = document.getElementById('note-input').value.trim();
        if(!note) return;
        fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name: currentUser, note: note }) }).then(() => { 
            alert("Sent!"); 
            document.getElementById('note-input').value = ""; 
        });
    }

    function showLockedNote() {
        if(prompt("Enter Password:") === "123") {
            document.getElementById('lock-btn').style.display = 'none';
            document.getElementById('prev-note-display').style.display = 'block';
            fetch(scriptURL).then(res => res.json()).then(data => {
                document.getElementById('prev-note-text').innerText = data.note.note;
                document.getElementById('prev-note-info').innerText = data.note.name + " â€¢ " + data.note.time;
            });
        }
    }

    function lockNoteAgain() { document.getElementById('prev-note-display').style.display = 'none'; document.getElementById('lock-btn').style.display = 'block'; }
    function logout() { updateStatus("Offline"); setTimeout(() => { location.reload(); }, 500); }
    function viewFullHistory() { if(prompt("Enter History Password (786):") === "786") { window.open('https://docs.google.com/spreadsheets/d/1_dDtsqDy5l_YBtIAjZfLGIQVqeoJHNYHJJqeu0oLKH4/edit', '_blank'); } }
</script>
</body>
</html>
